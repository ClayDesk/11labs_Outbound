# CodeFlowOps Documentation Drift Detection
# This workflow checks if your documentation is out of sync with your code.
# Learn more: https://codeflowops.com/docs/drift-detection

name: CodeFlowOps Documentation Drift Check

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Weekly check every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  drift-check:
    runs-on: ubuntu-latest
    name: Check Documentation Drift
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    # Skip if PR from fork (no secrets access)
    if: |
      github.event_name != 'pull_request' || 
      github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for Drift
        id: drift
        run: |
          echo "üîç Checking documentation drift..."
          
          # Read manifest
          if [ ! -f "./codeflowops-manifest.json" ]; then
            echo "‚ùå Manifest not found"
            exit 1
          fi
          
          MANIFEST=$(cat ./codeflowops-manifest.json)
          
          # Get changed files (for PRs)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | jq -R -s -c 'split("\n") | map(select(length > 0))' || echo "[]")
          fi
          
          # Call CodeFlowOps API
          RESPONSE=$(curl -s -X POST "https://codeflowops.com/api/drift/check" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CODEFLOWOPS_API_KEY }}" \
            -d "{
              \"manifest\": $MANIFEST,
              \"changedFiles\": $CHANGED_FILES,
              \"repo\": \"${{ github.repository }}\",
              \"sha\": \"${{ github.sha }}\",
              \"event\": \"${{ github.event_name }}\"
            }")
          
          echo "API Response: $RESPONSE"
          
          # Parse response
          DRIFT_DETECTED=$(echo "$RESPONSE" | jq -r '.driftDetected // false')
          SUMMARY=$(echo "$RESPONSE" | jq -r '.summary // "No drift detected"')
          
          echo "drift_detected=$DRIFT_DETECTED" >> $GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "$DRIFT_DETECTED" == "true" ]; then
            echo "‚ö†Ô∏è Documentation drift detected!"
          else
            echo "‚úÖ Documentation is up to date"
          fi
        env:
          CODEFLOWOPS_API_KEY: ${{ secrets.CODEFLOWOPS_API_KEY }}

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìö Documentation Drift Detected
              
${{ steps.drift.outputs.summary }}

---
*Generated by [CodeFlowOps](https://codeflowops.com) - Keep your docs in sync with code*`
            })
